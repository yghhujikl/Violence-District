-- [[ HEART AUTO FARM ]] --

local folder = workspace:WaitForChild("HeartCollectables")
local last_heart

local players = game:GetService("Players")
local localplayer = players.LocalPlayer

local camera = workspace.CurrentCamera
local screen_size = camera.ViewportSize

-- speed (bigger = faster)
local tween_speed = 150

function draw(type)
    local new_draw = Drawing.new(type)
    new_draw.Transparency = 1
    new_draw.Visible = true
    return new_draw
end

function is_valid(obj)
    return obj and obj.Parent ~= nil
end

function magnitude(point1, point2)
    local dx = point2.X - point1.X
    local dy = point2.Y - point1.Y
    local dz = point2.Z - point1.Z
    return math.sqrt(dx*dx + dy*dy + dz*dz)
end

function get_closest_heart()
    local closest_heart = nil
    local closest_distance = math.huge

    local character = localplayer.Character
    if not character then return nil, closest_distance end

    local humanoidrootpart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidrootpart then return nil, closest_distance end

    for _, heart in next, folder:GetChildren() do
        if is_valid(heart) and heart.Name == "HeartPickup" and heart:IsA("MeshPart") then
            local ok, heart_distance = pcall(function()
                return magnitude(heart.Position, humanoidrootpart.Position)
            end)

            if ok and heart_distance and heart_distance < closest_distance then
                closest_heart = heart
                closest_distance = heart_distance
            end
        end
    end

    return closest_heart, closest_distance
end

local can_tween = true

function tween_position(object, target, duration)
    local start_time = os.clock()
    local start_pos = object.Position
    local end_time = start_time + duration
    can_tween = false

    while os.clock() < end_time do
        if (not is_valid(object)) or (not is_valid(target)) then
            break
        end

        local alpha = (os.clock() - start_time) / duration
        if alpha > 1 then alpha = 1 end

        local tx, ty, tz = target.Position.X, target.Position.Y, target.Position.Z
        local sx, sy, sz = start_pos.X, start_pos.Y, start_pos.Z

        object.Position = Vector3.new(
            sx + (tx - sx) * alpha,
            sy + (ty - sy) * alpha,
            sz + (tz - sz) * alpha
        )

        -- stop physics pushing you away
        pcall(function()
            object.Velocity = Vector3.new(0, 0, 0)
        end)
    end

    can_tween = true
    pcall(function()
        object.Position = target.Position + Vector3.new(0, 2, 0)
    end)
end

function set_noclip()
    local character = localplayer.Character
    if character then
        for _, v in next, character:GetChildren() do
            if v:IsA("Part") or v:IsA("MeshPart") or v:IsA("BasePart") then
                v.CanCollide = false
            end
        end
    end
end

local status = draw("Text")
status.Center = true
status.Size = 18
status.Outline = true
status.Font = 2

function update_auto_farm()
    screen_size = camera.ViewportSize
    status.Position = Vector2.new(screen_size.X / 2, screen_size.Y * 0.2)

    set_noclip()

    local character = localplayer.Character
    if character then
        local humanoidrootpart = character:FindFirstChild("HumanoidRootPart")
        if humanoidrootpart then
            local closest_heart, heart_distance = get_closest_heart()

            if is_valid(closest_heart) then
                last_heart = closest_heart
                humanoidrootpart.Velocity = Vector3.new(0, 0, 0)

                status.Text = "Heart Auto Farm: Moving | Dist: " .. math.floor(heart_distance)

                if can_tween then
                    spawn(function()
                        tween_position(humanoidrootpart, closest_heart, heart_distance / tween_speed)
                    end)
                end
            else
                status.Text = "Heart Auto Farm: No hearts found"
                humanoidrootpart.Velocity = Vector3.new(0, 0, 0)
            end
        else
            status.Text = "Heart Auto Farm: Can't find RootPart"
        end
    else
        status.Text = "Heart Auto Farm: Can't find Character"
    end
end

while true do
    update_auto_farm()
    task.wait(0.05)
end
