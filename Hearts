
local folder = workspace:WaitForChild("HeartCollectables")

local players = game:GetService("Players")
local localplayer = players.LocalPlayer

local camera = workspace.CurrentCamera
local screen_size = camera.ViewportSize

-- SPEED SETTINGS
local snap_distance = 100000
local offset = Vector3.new(0, 2, 0)

function draw(type)
    local new_draw = Drawing.new(type)
    new_draw.Transparency = 1
    new_draw.Visible = true
    return new_draw
end

function is_valid(obj)
    return obj and obj.Parent ~= nil
end

function magnitude(point1, point2)
    local dx = point2.X - point1.X
    local dy = point2.Y - point1.Y
    local dz = point2.Z - point1.Z
    return math.sqrt(dx*dx + dy*dy + dz*dz)
end

-- COUNTER STUFF
local start_time = os.clock()
local collected = 0
local seen = {}

-- track when a heart disappears (means collected)
local function updateCollectedCount()
    for heart, _ in pairs(seen) do
        if not is_valid(heart) then
            seen[heart] = nil
            collected = collected + 1
        end
    end
end

function get_closest_heart()
    local closest_heart = nil
    local closest_distance = math.huge

    local character = localplayer.Character
    if not character then return nil, closest_distance end

    local humanoidrootpart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidrootpart then return nil, closest_distance end

    for _, heart in next, folder:GetChildren() do
        if is_valid(heart) and heart.Name == "HeartPickup" and heart:IsA("MeshPart") then
            seen[heart] = true

            local ok, heart_distance = pcall(function()
                return magnitude(heart.Position, humanoidrootpart.Position)
            end)

            if ok and heart_distance and heart_distance < closest_distance then
                closest_heart = heart
                closest_distance = heart_distance
            end
        end
    end

    return closest_heart, closest_distance
end

function set_noclip()
    local character = localplayer.Character
    if character then
        for _, v in next, character:GetChildren() do
            if v:IsA("Part") or v:IsA("MeshPart") or v:IsA("BasePart") then
                v.CanCollide = false
            end
        end
    end
end

local status = draw("Text")
status.Center = true
status.Size = 18
status.Outline = true
status.Font = 2

function update_auto_farm()
    screen_size = camera.ViewportSize
    status.Position = Vector2.new(screen_size.X / 2, screen_size.Y * 0.2)

    set_noclip()

    updateCollectedCount()

    local character = localplayer.Character
    if not character then
        status.Text = "Heart Auto Farm: No character"
        return
    end

    local humanoidrootpart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidrootpart then
        status.Text = "Heart Auto Farm: No HRP"
        return
    end

    local closest_heart, heart_distance = get_closest_heart()

    -- per hour estimate
    local elapsed = os.clock() - start_time
    local perHour = 0
    if elapsed > 1 then
        perHour = math.floor((collected / elapsed) * 3600)
    end

    if is_valid(closest_heart) then
        humanoidrootpart.Velocity = Vector3.new(0, 0, 0)

        -- SNAP
        humanoidrootpart.Position = closest_heart.Position + offset

        status.Text =
            "Heart Auto Farm " .. math.floor(heart_distance) ..
            " " .. tostring(collected) ..
            " " .. tostring(perHour) ..
            " " .. tostring(#folder:GetChildren())
    else
        status.Text =
            "Heart Auto Farm: No hearts found" ..
            " | idk bru" .. tostring(collected) ..
            " | idc bru" .. tostring(perHour)
    end
end

while true do
    update_auto_farm()
    task.wait(0)
end
